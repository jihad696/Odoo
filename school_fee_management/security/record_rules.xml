<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data noupdate="1">

        <!--
            RECORD RULES - ROW-LEVEL SECURITY

            These rules filter which records users can see based on their role.
            This is CRITICAL for multi-tenant security in parent portals.

            PERFORMANCE NOTE:
            - parent_id field is indexed for fast filtering
            - Rules use domain filters that translate to WHERE clauses in PostgreSQL
            - Proper indexing ensures these security checks don't slow down queries

            SECURITY NOTE:
            - Parents can ONLY see invoices where they are the parent
            - Accountants and admins see all records (no domain filter)
            - Separate rules for read/write/create/delete operations
        -->

        <!-- Student Invoice Record Rules -->

        <!-- Parents can only READ their own children's invoices -->
        <record id="student_invoice_parent_rule" model="ir.rule">
            <field name="name">Parent: See Only Own Children's Invoices</field>
            <field name="model_id" ref="model_school_student_invoice"/>
            <field name="domain_force">[('parent_id', '=', user.partner_id.id)]</field>
            <field name="groups" eval="[(4, ref('group_school_parent'))]"/>
            <field name="perm_read" eval="True"/>
            <field name="perm_write" eval="False"/>
            <field name="perm_create" eval="False"/>
            <field name="perm_unlink" eval="False"/>
        </record>

        <!-- Accountants see all invoices -->
        <record id="student_invoice_accountant_rule" model="ir.rule">
            <field name="name">Accountant: All Invoices</field>
            <field name="model_id" ref="model_school_student_invoice"/>
            <field name="domain_force">[(1, '=', 1)]</field>
            <field name="groups" eval="[(4, ref('group_school_accountant'))]"/>
            <field name="perm_read" eval="True"/>
            <field name="perm_write" eval="True"/>
            <field name="perm_create" eval="True"/>
            <field name="perm_unlink" eval="True"/>
        </record>

        <!-- Administrators see all invoices -->
        <record id="student_invoice_admin_rule" model="ir.rule">
            <field name="name">Admin: All Invoices</field>
            <field name="model_id" ref="model_school_student_invoice"/>
            <field name="domain_force">[(1, '=', 1)]</field>
            <field name="groups" eval="[(4, ref('group_school_admin'))]"/>
        </record>

        <!-- Payment Transaction Record Rules -->

        <!-- Parents can only READ payment transactions for their children's invoices -->
        <record id="payment_transaction_parent_rule" model="ir.rule">
            <field name="name">Parent: See Only Own Children's Payments</field>
            <field name="model_id" ref="model_school_payment_transaction"/>
            <field name="domain_force">[('student_invoice_id.parent_id', '=', user.partner_id.id)]</field>
            <field name="groups" eval="[(4, ref('group_school_parent'))]"/>
            <field name="perm_read" eval="True"/>
            <field name="perm_write" eval="False"/>
            <field name="perm_create" eval="False"/>
            <field name="perm_unlink" eval="False"/>
        </record>

        <!-- Accountants see all payment transactions -->
        <record id="payment_transaction_accountant_rule" model="ir.rule">
            <field name="name">Accountant: All Payment Transactions</field>
            <field name="model_id" ref="model_school_payment_transaction"/>
            <field name="domain_force">[(1, '=', 1)]</field>
            <field name="groups" eval="[(4, ref('group_school_accountant'))]"/>
        </record>

        <!-- Administrators see all payment transactions -->
        <record id="payment_transaction_admin_rule" model="ir.rule">
            <field name="name">Admin: All Payment Transactions</field>
            <field name="model_id" ref="model_school_payment_transaction"/>
            <field name="domain_force">[(1, '=', 1)]</field>
            <field name="groups" eval="[(4, ref('group_school_admin'))]"/>
        </record>

        <!-- Fee Structure - No record rules needed (access rights handle this) -->
        <!-- All authenticated users can read fee structures -->
        <!-- Only admins can modify (controlled by access rights) -->

    </data>
</odoo>