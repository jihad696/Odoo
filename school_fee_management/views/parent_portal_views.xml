<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>

        <!--
            Parent Portal Views
            Simplified, user-friendly views designed for parents to track their children's invoices
        -->

        <!-- Parent Portal - Student Invoice Kanban -->
        <record id="view_student_invoice_kanban_parent" model="ir.ui.view">
            <field name="name">school.student.invoice.kanban.parent</field>
            <field name="model">school.student.invoice</field>
            <field name="priority">20</field>
            <field name="arch" type="xml">
                <kanban class="o_kanban_mobile" default_group_by="student_id">
                    <field name="student_id"/>
                    <field name="invoice_date"/>
                    <field name="due_date"/>
                    <field name="amount_total"/>
                    <field name="amount_residual"/>
                    <field name="state"/>
                    <field name="is_overdue"/>
                    <field name="days_overdue"/>
                    <field name="semester"/>
                    <field name="currency_id"/>
                    <templates>
                        <t t-name="kanban-box">
                            <div t-attf-class="oe_kanban_global_click #{record.is_overdue.raw_value ? 'oe_kanban_color_2' : ''}">
                                <div class="oe_kanban_content">
                                    <div class="o_kanban_record_top">
                                        <div class="o_kanban_record_headings">
                                            <strong class="o_kanban_record_title">
                                                <field name="semester"/> Semester <field name="academic_year"/>
                                            </strong>
                                            <div class="o_kanban_record_subtitle">
                                                Student: <field name="student_id"/>
                                            </div>
                                        </div>
                                        <span class="float-end badge"
                                              t-attf-class="badge-#{record.state.raw_value === 'paid' ? 'success' : record.state.raw_value === 'overdue' ? 'danger' : record.state.raw_value === 'partial' ? 'warning' : 'info'}">
                                            <field name="state"/>
                                        </span>
                                    </div>
                                    <div class="o_kanban_record_body">
                                        <div>Invoice Date: <field name="invoice_date"/></div>
                                        <div>Due Date: <field name="due_date"/></div>
                                        <div t-if="record.is_overdue.raw_value" class="text-danger mt-2">
                                            <i class="fa fa-exclamation-triangle"/>
                                            <strong>OVERDUE</strong> - <field name="days_overdue"/> days past due
                                        </div>
                                    </div>
                                    <div class="o_kanban_record_bottom mt-3">
                                        <div class="row">
                                            <div class="col-6">
                                                <strong>Total Amount:</strong><br/>
                                                <span class="text-primary">
                                                    <field name="amount_total" widget="monetary"/>
                                                </span>
                                            </div>
                                            <div class="col-6 text-end">
                                                <strong>Amount Due:</strong><br/>
                                                <span t-attf-class="#{record.amount_residual.raw_value > 0 ? 'text-danger' : 'text-success'}">
                                                    <field name="amount_residual" widget="monetary"/>
                                                </span>
                                            </div>
                                        </div>
                                        <div class="progress mt-2" style="height: 20px;">
                                            <div class="progress-bar bg-success" role="progressbar"
                                                 t-attf-style="width: #{record.payment_percentage.raw_value}%"
                                                 t-attf-aria-valuenow="#{record.payment_percentage.raw_value}"
                                                 aria-valuemin="0" aria-valuemax="100">
                                                <field name="payment_percentage"/>% Paid
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </t>
                    </templates>
                </kanban>
            </field>
        </record>

        <!-- Parent Portal - Student Invoice list (Simplified) -->
        <record id="view_student_invoice_list_parent" model="ir.ui.view">
            <field name="name">school.student.invoice.list.parent</field>
            <field name="model">school.student.invoice</field>
            <field name="priority">20</field>
            <field name="arch" type="xml">
                <list string="My Children's Invoices" create="false" delete="false"
                      decoration-success="state == 'paid'"
                      decoration-danger="state == 'overdue'"
                      decoration-warning="state == 'partial'">
                    <field name="student_id"/>
                    <field name="semester"/>
                    <field name="academic_year"/>
                    <field name="invoice_date"/>
                    <field name="due_date"/>
                    <field name="amount_total" sum="Total" widget="monetary"/>
                    <field name="amount_residual" sum="Total Due" widget="monetary"/>
                    <field name="state" widget="badge"/>
                    <field name="currency_id" column_invisible="1"/>
                    <button name="action_view_invoice" string="View Invoice" type="object" icon="fa-file-text-o"/>
                </list>
            </field>
        </record>

        <!-- Parent Portal - Student Invoice Form (Read-only) -->
        <record id="view_student_invoice_form_parent" model="ir.ui.view">
            <field name="name">school.student.invoice.form.parent</field>
            <field name="model">school.student.invoice</field>
            <field name="priority">20</field>
            <field name="arch" type="xml">
                <form string="Invoice Details" create="false" edit="false" delete="false">
                    <header>
                        <field name="state" widget="statusbar" statusbar_visible="draft,sent,partial,paid"/>
                    </header>
                    <sheet>
                        <div class="alert alert-danger" role="alert" invisible="not is_overdue">
                            <strong>This invoice is overdue!</strong>
                            Payment was due on <field name="due_date" readonly="1"/>
                            (<field name="days_overdue" readonly="1"/> days ago)
                        </div>
                        <div class="oe_title">
                            <h1>Invoice for <field name="student_id" readonly="1"/></h1>
                            <h3><field name="semester" readonly="1"/> Semester <field name="academic_year" readonly="1"/></h3>
                        </div>
                        <group>
                            <group string="Invoice Information">
                                <field name="display_name" readonly="1"/>
                                <field name="invoice_date" readonly="1"/>
                                <field name="due_date" readonly="1"/>
                                <field name="grade_level" readonly="1"/>
                            </group>
                            <group string="Payment Information">
                                <label for="amount_total" string="Total Amount"/>
                                <div>
                                    <field name="amount_total" widget="monetary" readonly="1" class="oe_inline"/>
                                    <field name="currency_id" invisible="1"/>
                                </div>
                                <label for="amount_residual" string="Amount Due"/>
                                <div>
                                    <field name="amount_residual" widget="monetary" readonly="1"
                                           class="oe_inline text-danger"
                                           style="font-size: 1.5em; font-weight: bold;"/>
                                </div>
                                <field name="payment_percentage" widget="percentpie" readonly="1"/>
                            </group>
                        </group>
                        <group>
                            <button name="action_view_invoice" string="Download Invoice PDF" type="object"
                                    class="btn-primary" icon="fa-download"/>
                        </group>
                        <notebook>
                            <page string="Payment History">
                                <field name="is_overdue" invisible="1"/>
                                <!-- Payment transactions will be shown here -->
                                <p class="text-muted">Payment history and details</p>
                            </page>
                        </notebook>
                    </sheet>
                </form>
            </field>
        </record>

        <!-- Parent Portal - Payment Transaction list (Read-only) -->
        <record id="view_payment_transaction_list_parent" model="ir.ui.view">
            <field name="name">school.payment.transaction.list.parent</field>
            <field name="model">school.payment.transaction</field>
            <field name="priority">20</field>
            <field name="arch" type="xml">
                <list string="Payment History" create="false" edit="false" delete="false"
                      decoration-success="state == 'reconciled'">
                    <field name="payment_date"/>
                    <field name="name"/>
                    <field name="student_id"/>
                    <field name="amount" widget="monetary"/>
                    <field name="payment_method"/>
                    <field name="payment_reference"/>
                    <field name="state" widget="badge"/>
                    <field name="currency_id" column_invisible="1"/>
                </list>
            </field>
        </record>

        <!-- Parent Portal Actions -->
        <record id="action_parent_portal_invoices" model="ir.actions.act_window">
            <field name="name">My Children's Invoices</field>
            <field name="res_model">school.student.invoice</field>
            <field name="view_mode">kanban,list,form</field>
            <field name="view_ids" eval="[(5, 0, 0),
                (0, 0, {'view_mode': 'kanban', 'view_id': ref('view_student_invoice_kanban_parent')}),
                (0, 0, {'view_mode': 'list', 'view_id': ref('view_student_invoice_list_parent')}),
                (0, 0, {'view_mode': 'form', 'view_id': ref('view_student_invoice_form_parent')})]"/>
            <field name="domain">[('parent_id', '=', uid)]</field>
            <field name="context">{'search_default_unpaid': 1}</field>
            <field name="help" type="html">
                <p class="o_view_nocontent_empty_folder">
                    No invoices found
                </p>
                <p>
                    Your children's school fee invoices will appear here.
                </p>
            </field>
        </record>

        <record id="action_parent_portal_payments" model="ir.actions.act_window">
            <field name="name">Payment History</field>
            <field name="res_model">school.payment.transaction</field>
            <field name="view_mode">list</field>
            <field name="view_id" ref="view_payment_transaction_list_parent"/>
            <field name="domain">[('student_invoice_id.parent_id', '=', uid)]</field>
            <field name="help" type="html">
                <p class="o_view_nocontent_empty_folder">
                    No payment history
                </p>
                <p>
                    All payments made for your children's invoices will be listed here.
                </p>
            </field>
        </record>

    </data>
</odoo>